# esp32 camera OV2640 Module 分析报告

目前通过在WROVER_KIT上使用OV2640 Module摄像头传感器，可在运行扫描二维码任务的同时web实时监控视频流，并做了相关数据分析，分析如下：

## Camera 相关配置

摄像头型号：OV2640

摄像头输出大小：240*176

摄像头输出格式：GRAYSCALE

摄像头输出xclk：16M

摄像头JPEG质量：10-20

摄像头分配的帧缓冲区数量：1-2

## 数据分析

由于该测试任务需适配扫描二维码情况，故将摄像头的输出格式设置为GRAYSCALE（灰阶）

为了达到更快的视频流扫描传输帧率，同时满足二维码扫描解析功能，故将摄像头的输出大小尽量压低

#### 摄像头可选输出格式如下：

```
    FRAMESIZE_96X96,    // 96x96
    FRAMESIZE_QQVGA,    // 160x120
    FRAMESIZE_QCIF,     // 176x144
    FRAMESIZE_HQVGA,    // 240x176
    FRAMESIZE_240X240,  // 240x240
    FRAMESIZE_QVGA,     // 320x240
    FRAMESIZE_CIF,      // 400x296
    FRAMESIZE_HVGA,     // 480x320
    FRAMESIZE_VGA,      // 640x480
    FRAMESIZE_SVGA,     // 800x600
    FRAMESIZE_XGA,      // 1024x768
    FRAMESIZE_HD,       // 1280x720
    FRAMESIZE_SXGA,     // 1280x1024
    FRAMESIZE_UXGA,     // 1600x1200
```

#### 1.只开启wifi图传至web情况

| 摄像头输出大小 | 摄像头输出xclk | 摄像头分配的帧缓冲区数量 | 图传帧率 | 输出效果                                                     |
| -------------- | -------------- | ------------------------ | -------- | ------------------------------------------------------------ |
| 160x120        | 16M            | 1                        | 5        | 输出帧率稳定                                                 |
| 160x120        | 16M            | 2                        | 10       | 输出帧率稳定                                                 |
| 176*144        | 16M            | 1                        | 5        | 输出帧率稳定                                                 |
| 176*144        | 16M            | 2                        | 11       | 输出帧率不稳定，平均帧率在10fps以上，峰值可达28fps           |
| 240x176        | 16M            | 1                        | 5        | 输出帧率稳定                                                 |
| 240x176        | 16M            | 2                        | 13       | 输出帧率不稳定，平均帧率大概在12-13fps，峰值可达20fps，大概运行一分半钟后开始出现两帧的分界线 |
| 240x240        | 16M            | 1                        | 5        | 输出帧率较为稳定                                             |
| 240x240        | 16M            | 2                        | 11       | 输出帧率不稳定，平均帧率大概在11fps，峰值可达18fps；识别二维码效果与240x176类似；但是运行一分钟后开始出现两帧的分界线 |
| 320x240        | 16M            | 1                        | 5        | 输出帧率较为不稳定，会出现卡顿                               |
| 320x240        | 16M            | 2                        | 8        | 输出帧率不稳定，会出现卡顿平均帧率大概在7-8fps，峰值可达12fps，大概运行半分钟后开始出现两帧的分界线 |

#### 2.增加摄像头扫描解析二维码任务

| 摄像头输出大小 | 摄像头输出xclk | 摄像头分配的帧缓冲区数量 | 图传帧率 | 输出效果                                                     |
| -------------- | :------------: | :----------------------: | -------- | ------------------------------------------------------------ |
| 160x120        |      16M       |            1             | 0.8      | 输出卡顿                                                     |
| 160x120        |      16M       |            2             | 10       | 输出帧率较为稳定；但因为画面太小，二维码距离太远不容易解析，距离太近容易超过摄像头画面边界 |
| 176*144        |      16M       |            1             | 0.7      | 输出卡顿                                                     |
| 176*144        |      16M       |            2             | 10       | 输出帧率较为不稳定，平均帧率在10fps以上，峰值可达30fps；识别二维码效果优于160*120，可以在缓慢移动中识别 |
| 240x176        |      16M       |            1             | 0.7      | 输出卡顿                                                     |
| 240x176        |      16M       |            2             | 11       | 输出帧率较为不稳定，平均帧率在10fps以上，峰值可达19fps；识别二维码效果优于176*144，可以在缓慢移动中识别；但是运行两分钟后开始出现两帧的分界线 |
| 240x240        |      16M       |            1             | 0.7      | 输出卡顿                                                     |
| 240x240        |      16M       |            2             | 10       | 输出帧率较为不稳定，平均帧率在9fps左右，峰值可达19fps；识别二维码效果优于176*144，可以在缓慢移动中识别；但是运行一分钟后开始出现两帧的分界线 |
| 320x240        |      16M       |            1             | 0.7      | 输出卡顿                                                     |
| 320x240        |      16M       |            2             | 9        | 输出帧率较为不稳定，平均帧率在8fps左右，峰值可达12fps；系统运行五分钟之后识别二维码效果变差，可以在缓慢移动中识别；但是运行半分钟后开始出现两帧的分界线 |

## 总结

1.摄像头分配的帧缓冲区数量为1时，只开图传至web的传输帧速率稳定在5fps，随着摄像头输出图像格式大小越大，视频状况会渐渐出现卡顿；当同时运行二维码扫描解析任务时，视频帧率变为0.7fps，输出很卡顿。

2.摄像头分配的帧缓冲区数量为2时，只开图传至web的传输情况较为良好，当增加摄像头扫描解析二维码任务后，160 x 120 、 176 x 144 、 240 x 176图像大小输出情况较为良好，平均帧率都在10fps左右，160 x 120 、 176 x 144格式图像较小不利于二维码扫描，整体来看240 x 176图像大小运行最佳

3.摄像头分配的帧缓冲区数量为2时，图像大小240x176及以上均会在系统运行后的一段时间出现画面被分割的现象，经测试，通过增大jpeg_quality这一参数可以延缓画面被分割的时间（jpeg_quality范围0-63 ，数值越小图像质量越好），画面被分割这一问题待解决。